# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions

name: Build and deploy ASP.Net Core app to Azure Web App - timetracker-anga

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Set up .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'

      - name: Build with dotnet
        run: dotnet build --configuration Release

      - name: dotnet publish
        run: dotnet publish -c Release -o "${{env.DOTNET_ROOT}}/myapp"

      - name: Upload artifact for deployment job
        uses: actions/upload-artifact@v4
        with:
          name: .net-app
          path: ${{env.DOTNET_ROOT}}/myapp

  deploy:
    runs-on: windows-latest
    needs: build
    environment:
      name: 'Production'
      url: ${{ steps.deploy-to-webapp.outputs.webapp-url }}
    permissions:
      id-token: write #This is required for requesting the JWT
      contents: read #This is required for actions/checkout

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: .net-app
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_7D03F74903A64C21B4C28320498AC30D }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_56EB407704A14DF2BF34AD9C6A8CCA1C }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_6593FD856A7E4DF8804CB7CE8830285D }}

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'timetracker-anga'
          slot-name: 'staging'
          package: .
      
      - name: Notify Microsoft Teams
        if: success()
        shell: pwsh
        run: |
          $payload = @{
            "@type" = "MessageCard"
            "@context" = "http://schema.org/extensions"
            summary = "Deploy notifiering"
            themeColor = "0076D7"
            title = "‚úÖ Deploy klar till Azure Staging"
            text = "En ny version av TimeTracker har just pushats till staging-slotten. Dags att testa! üéâ"
          } | ConvertTo-Json -Depth 10

          Invoke-RestMethod -Uri "${{ secrets.TEAMS_WEBHOOK_URL }}" -Method Post -ContentType "application/json" -Body $payload

      - name: Notify Microsoft Teams on failure
        if: failure()
        shell: pwsh
        run: |
          $payload = @{
            "@type" = "MessageCard"
            "@context" = "http://schema.org/extensions"
            summary = "Deploy notifiering"
            themeColor = "FF0000"
            title = "‚ùå Deploy misslyckades"
            text = "TimeTracker deploy till staging-slotten misslyckades. Kolla GitHub Actions-loggen f√∂r mer info. üö®"
          } | ConvertTo-Json -Depth 10

          Invoke-RestMethod -Uri "${{ secrets.TEAMS_WEBHOOK_URL }}" -Method Post -ContentType "application/json" -Body $payload