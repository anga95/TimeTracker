@page "/tracktime"
@page "/"
@using TimeTracker.Demo
@using TimeTracker.Models
@using TimeTracker.Services
@inject ITimeTrackingService TimeService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime

<div class="card mb-4">
    <div class="card-body">
        <h3 class="card-title">Tidrapportering</h3>
        <button class="btn btn-outline-secondary mb-3" @onclick="OpenProjectModal">
            Skapa nytt projekt
        </button>
        @if (showProjectModal)
        {
            <div class="modal fade show" style="display:block;" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Skapa nytt projekt</h5>
                            <button type="button" class="btn-close" @onclick="CloseProjectModal"></button>
                        </div>
                        <div class="modal-body">
                            <InputText @bind-Value="newProjectName" class="form-control" placeholder="Projektnamn" />
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" @onclick="CloseProjectModal">Avbryt</button>
                            <button class="btn btn-primary" @onclick="CreateProject">Skapa</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-backdrop fade show"></div>
        }

        <hr />

        <!-- Formulär för tidrapportering -->
        <EditForm Model="@newWorkItem" OnValidSubmit="@HandleValidSubmit" class="mb-3">
            <fieldset disabled="@string.IsNullOrEmpty(currentUserId)">
            <div class="row g-3 align-items-end">
                <!-- Projekt (dropdown) -->
                <div class="col-md-3">
                    <label class="form-label">Projekt</label>
                    <select class="form-select" @bind="newWorkItem.ProjectId">
                        <option value="0">-- Välj projekt --</option>
                        @if (projects != null)
                        {
                            @foreach (var p in projects)
                            {
                                <option value="@p.Id">@p.Name</option>
                            }
                        }
                    </select>
                </div>

                <!-- Datum -->
                <div class="col-md-3">
                    <label class="form-label">Datum</label>
                    <InputDate @bind-Value="newWorkItem.WorkDate" class="form-control" />
                </div>

                <!-- Timmar -->
                <div class="col-md-2">
                    <label class="form-label">Timmar</label>
                    <InputNumber @bind-Value="newWorkItem.HoursWorked" class="form-control" />
                </div>

                <!-- Kommentar -->
                <div class="col-md-4">
                    <label class="form-label">Kommentar</label>
                    <InputTextArea @bind-Value="newWorkItem.Comment" class="form-control" rows="1" />
                </div>

                <!-- Submit-knapp -->
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary">Lägg till tid</button>
                </div>
            </div>
            </fieldset>
            @if (string.IsNullOrEmpty(currentUserId))
            {
                <div class="alert alert-warning mt-3">
                    För att spara din tidrapportering måste du vara inloggad.
                </div>
            }
        </EditForm>
    </div>
</div>

<div class="my-4">
    <hr />
</div>

<!-- Lista av tidrapporterade dagar -->
<div>
    @if (workDays != null && workDays.Any())
    {
        @foreach (var day in workDays)
        {
            <h4>@day.Date.ToShortDateString() (Summa: @GetRoundedTotal(day) h)</h4>
            <ul>
                @foreach (var (ProjectName, Hours) in GetProjectSummary(day))
                {
                    <li><b>@ProjectName</b>: @Hours h</li>
                }
            </ul>
            <table class="table table-striped table-hover table-bordered">
                <thead>
                    <tr>
                        <th>Projekt</th>
                        <th>Timmar</th>
                        <th>Kommentar</th>
                        <th>Ta bort</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in day.WorkItems)
                    {
                        <tr>
                            <td>@item.Project?.Name</td>
                            <td>@item.HoursWorked</td>
                            <td>@item.Comment</td>
                            <td>
                                <button class="btn btn-danger btn-sm" @onclick="() => ConfirmDelete(item.Id)">
                                    Ta bort
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    }
    else
    {
        <p>Inga tidrapporterade dagar ännu.</p>
    }
</div>

@code {
    private bool showProjectModal = false;
    private string newProjectName = "";
    private string currentUserId = "";

    private WorkItem newWorkItem = new() { WorkDate = DateTime.Today };
    private List<WorkDay>? workDays;
    private List<Project>? projects;

    private List<Project> demoProjects = new()
    {
        new Project { Id = 1, Name = "Demo Projekt 1" },
        new Project { Id = 2, Name = "Demo Projekt 2" }
    };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        projects = await TimeService.GetProjectsAsync(currentUserId);
        workDays = await TimeService.GetWorkDaysAsync(currentUserId);
        
    }

    private List<WorkDay> GetDemoWorkDays()
    {
        return new List<WorkDay>
        {
            // Dag 1 med 3 uppdrag
            new WorkDay
            {
                Id = 1,
                Date = DateTime.Today.AddDays(-1),
                WorkItems = new List<WorkItem>
                {
                    new WorkItem { Id = 1, ProjectId = 1, Project = demoProjects.First(), HoursWorked = 3, WorkDate = DateTime.Today.AddDays(-1), Comment = "Designade en futuristisk användarupplevelse med neonfärger.", UserId = "demo" },
                    new WorkItem { Id = 2, ProjectId = 2, Project = demoProjects.Last(), HoursWorked = 2.5, WorkDate = DateTime.Today.AddDays(-1), Comment = "Testade en AI-assistent som pratade med enhörningar.", UserId = "demo" },
                    new WorkItem { Id = 3, ProjectId = 1, Project = demoProjects.First(), HoursWorked = 1.5, WorkDate = DateTime.Today.AddDays(-1), Comment = "Skrev en poetisk dokumentation.", UserId = "demo" }
                }
            },
            // Dag 2 med 2 uppdrag
            new WorkDay
            {
                Id = 2,
                Date = DateTime.Today.AddDays(-2),
                WorkItems = new List<WorkItem>
                {
                    new WorkItem { Id = 4, ProjectId = 1, Project = demoProjects.First(), HoursWorked = 4, WorkDate = DateTime.Today.AddDays(-2), Comment = "Experimenterade med hologram och 3D-effekter.", UserId = "demo" },
                    new WorkItem { Id = 5, ProjectId = 2, Project = demoProjects.Last(), HoursWorked = 2, WorkDate = DateTime.Today.AddDays(-2), Comment = "Införde interaktiva easter eggs.", UserId = "demo" }
                }
            },
            // Dag 3 med 2 uppdrag
            new WorkDay
            {
                Id = 3,
                Date = DateTime.Today.AddDays(-3),
                WorkItems = new List<WorkItem>
                {
                    new WorkItem { Id = 6, ProjectId = 1, Project = demoProjects.First(), HoursWorked = 5, WorkDate = DateTime.Today.AddDays(-3), Comment = "Kodade en spelifierad tidrapportering med poängsystem.", UserId = "demo" },
                    new WorkItem { Id = 7, ProjectId = 2, Project = demoProjects.Last(), HoursWorked = 2, WorkDate = DateTime.Today.AddDays(-3), Comment = "Skapade en AI-genererad kommentar med oväntad twist.", UserId = "demo" }
                }
            },
            // Dag 4 med 2 uppdrag
            new WorkDay
            {
                Id = 4,
                Date = DateTime.Today.AddDays(-4),
                WorkItems = new List<WorkItem>
                {
                    new WorkItem { Id = 8, ProjectId = 1, Project = demoProjects.First(), HoursWorked = 3.5, WorkDate = DateTime.Today.AddDays(-4), Comment = "Optimerade prestanda med magiska kodtrick.", UserId = "demo" },
                    new WorkItem { Id = 9, ProjectId = 2, Project = demoProjects.Last(), HoursWorked = 1, WorkDate = DateTime.Today.AddDays(-4), Comment = "Fixade små buggar med humor.", UserId = "demo" }
                }
            },
            // Dag 5 med 3 uppdrag
            new WorkDay
            {
                Id = 5,
                Date = DateTime.Today.AddDays(-5),
                WorkItems = new List<WorkItem>
                {
                    new WorkItem { Id = 10, ProjectId = 1, Project = demoProjects.First(), HoursWorked = 4, WorkDate = DateTime.Today.AddDays(-5), Comment = "Experimenterade med UI-koncept inspirerade av naturen.", UserId = "demo" },
                    new WorkItem { Id = 11, ProjectId = 2, Project = demoProjects.Last(), HoursWorked = 3, WorkDate = DateTime.Today.AddDays(-5), Comment = "Implementerade en spännande backend-funktion.", UserId = "demo" },
                    new WorkItem { Id = 12, ProjectId = 1, Project = demoProjects.First(), HoursWorked = 1, WorkDate = DateTime.Today.AddDays(-5), Comment = "Skrev en episk commit-historia.", UserId = "demo" }
                }
            },
            // Dag 6 med 2 uppdrag
            new WorkDay
            {
                Id = 6,
                Date = DateTime.Today.AddDays(-6),
                WorkItems = new List<WorkItem>
                {
                    new WorkItem { Id = 13, ProjectId = 2, Project = demoProjects.Last(), HoursWorked = 3, WorkDate = DateTime.Today.AddDays(-6), Comment = "Testade integration med en fiktiv rymdstation.", UserId = "demo" },
                    new WorkItem { Id = 14, ProjectId = 1, Project = demoProjects.First(), HoursWorked = 2, WorkDate = DateTime.Today.AddDays(-6), Comment = "Kodade om tankar till text.", UserId = "demo" }
                }
            },
            // Dag 7 med 2 uppdrag
            new WorkDay
            {
                Id = 7,
                Date = DateTime.Today.AddDays(-7),
                WorkItems = new List<WorkItem>
                {
                    new WorkItem { Id = 15, ProjectId = 1, Project = demoProjects.First(), HoursWorked = 4.5, WorkDate = DateTime.Today.AddDays(-7), Comment = "Skapade en interaktiv demo med animerade grafer.", UserId = "demo" },
                    new WorkItem { Id = 16, ProjectId = 2, Project = demoProjects.Last(), HoursWorked = 2.5, WorkDate = DateTime.Today.AddDays(-7), Comment = "Förtrollade systemet med magiska AI-funktioner.", UserId = "demo" }
                }
            }
        };
    }

    private void OpenProjectModal() => showProjectModal = true;

    private void CloseProjectModal()
    {
        showProjectModal = false;
        newProjectName = "";
    }

    private async Task CreateProject()
    {
        if (!string.IsNullOrWhiteSpace(newProjectName))
        {
            await TimeService.CreateProjectAsync(newProjectName, currentUserId);
            projects = await TimeService.GetProjectsAsync(currentUserId);
            CloseProjectModal();
        }
    }

    private async Task HandleValidSubmit()
    {
        if (newWorkItem.ProjectId == 0)
        {
            // Hantera fel om inget projekt är valt
            return;
        }

        await TimeService.AddWorkItemAsync(newWorkItem, currentUserId);
        workDays = await TimeService.GetWorkDaysAsync(currentUserId);
        newWorkItem = new() { WorkDate = DateTime.Today };
    }

    private IEnumerable<(string ProjectName, double Hours)> GetProjectSummary(WorkDay day)
    {
        return day.WorkItems
            .GroupBy(wi => wi.Project?.Name ?? "Okänt projekt")
            .Select(g => (ProjectName: g.Key, Hours: g.Sum(wi => wi.HoursWorked)));
    }

    private double GetRoundedTotal(WorkDay day)
    {
        var total = day.WorkItems.Sum(wi => wi.HoursWorked);
        return Math.Ceiling(total * 2) / 2;
    }

    private async Task ConfirmDelete(int workItemId)
    {
        bool confirmed = await JSRuntime.InvokeAsync<bool>(
            "confirm",
            "Är du säker på att du vill ta bort denna tidpost?"
        );

        if (confirmed)
        {
            await TimeService.DeleteWorkItemAsync(workItemId);
            workDays = await TimeService.GetWorkDaysAsync(currentUserId);
        }
    }
}